function LightenDarkenColor(e,o){var t=!1;"#"==e[0]&&(e=e.slice(1),t=!0);var n=parseInt(e,16),r=(n>>16)+o;r>255?r=255:r<0&&(r=0);var a=(n>>8&255)+o;a>255?a=255:a<0&&(a=0);var i=(255&n)+o;return i>255?i=255:i<0&&(i=0),(t?"#":"")+(i|a<<8|r<<16).toString(16)}function hexToRgb(e){var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null}function GUID(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+"-"+e()}var FLOW_DEFAULTS={DefaultAnchorNodeSpacing:10,DefaultCurveColor:"#6dc1ff",ShowPlanarMid:!1,ShowCurveAnchors:!1,DefaultNodeColor:"#007c6",DefaultContainerHeightFraction:1,ShowEventBoxes:!0,DefaultCurveIsSolid:!1,DefaultCuveStrokeDasharray:"2, 2",TouchEditMode:!1,EventBoxHeight:120,EventBoxWidth:180,BaseAnchors:[]},FlowBoxNode=function(){return function(e){this.nodeData=e,this.lower=e.lower,this.upper=e.upper,this.nodeColor=e.nodeColor,void 0===this.nodeData.id&&(this.nodeData.id=GUID())}}(),FlowAnchor=function(){return function(){}}(),CurveAnchor=function(){return function(){this.index=-1}}(),AnchorBase=function(){return function(e,o){this.offsetX=0,this.offsetY=0,this.offsetX=e,this.offsetY=o}}(),FlowBox=function(){function e(e,o,t,n){this.anchors=[],this.lastAnchorAtLength=null,this.curveAnchors=[],this.lastCurveAnchor=null;var r=this;r.selectionCallBack=n,r.baseAnchors=[],r.DEFAULTS=e,r.container=d3.select(document.getElementById(o)),r.container.node().classList.add("flow-box-container");var a=r.container.node().getBoundingClientRect().width;r.containerWidth=a;var i=window.innerHeight;1!==r.DEFAULTS.DefaultContainerHeightFraction?(r.containerHeight=i*r.DEFAULTS.DefaultContainerHeightFraction,r.container.node().style.height=r.containerHeight+"px"):r.containerHeight=r.container.node().getBoundingClientRect().height,r.planarY=.5*r.containerHeight,setTimeout(function(){r.svg=r.container.append("svg").attr("width",a).attr("height",r.containerHeight),setTimeout(function(){r.populateCurveAnchorBase(),r.extendPlanarCurve(),r.initialize(t)})})}return e.prototype.resetCurve=function(){var e=this;e.curveAnchors.forEach(function(e){e.anchor.remove()}),e.curveAnchors=[],e.curve&&e.curve.remove()},e.prototype.initialize=function(e){var o=this;o.svg.empty(),o.DEFAULTS.ShowPlanarMid&&o.drawPlanarMidLine(),o.initNodes(e)},e.prototype.initNodes=function(e){var o=this;e.forEach(function(e){var t=new FlowBoxNode(e);o.addAnchor(t,!1)})},e.prototype.getBaseAnchors=function(){return this.DEFAULTS.BaseAnchors},e.prototype.populateCurveAnchorBase=function(){var e=this,o=e.containerHeight/5;e.baseAnchors=[],e.DEFAULTS.BaseAnchors&&e.DEFAULTS.BaseAnchors.length>0?e.DEFAULTS.BaseAnchors.push():(e.DEFAULTS.BaseAnchors.push([0,100]),e.DEFAULTS.BaseAnchors.push([200,1*-o]),e.DEFAULTS.BaseAnchors.push([300,2*-o]),e.DEFAULTS.BaseAnchors.push([50,1.5*o]),e.DEFAULTS.BaseAnchors.push([200,1.7*o]),e.DEFAULTS.BaseAnchors.push([200,1.5*-o]),e.DEFAULTS.BaseAnchors.push([200,1.7*-o]),e.DEFAULTS.BaseAnchors.push([50,1*o]),e.DEFAULTS.BaseAnchors.push([150,1.5*o]),e.DEFAULTS.BaseAnchors.push([200,0])),e.DEFAULTS.BaseAnchors.forEach(function(o){e.baseAnchors.push(new AnchorBase(o[0],o[1]))})},e.prototype.extendPlanarCurve=function(){var e=this;null==e.lastCurveAnchor&&(e.lastCurveAnchor=[0,0]),e.baseAnchors.forEach(function(o,t){e.creatCurveAnchor(t+1,o)}),e.drawPlanarCurve()},e.prototype.creatCurveAnchor=function(e,o){var t=this,n=new CurveAnchor;n.index=e,n.anchorBase=o;var r=t.lastCurveAnchor[0]+o.offsetX,a=t.planarY+o.offsetY;n.data=[r,a],t.lastCurveAnchor=[r,a],t.curveAnchors.push(n)},e.prototype.drawPlanarCurve=function(){var e=this,o=null;e.captureMouseMove=!1;var t=function(t){if(e.activeCurveAnchor&&o){var n=t.clientX-o.left,r=t.clientY-o.top;e.activeCurveAnchor.anchor.attr("cx",n),e.activeCurveAnchor.anchor.attr("cy",r);var a=n-e.activeCurveAnchor.data[0];e.baseAnchors[e.activeCurveAnchor.index].offsetX=e.baseAnchors[e.activeCurveAnchor.index].offsetX+a,a=r-e.activeCurveAnchor.data[1],e.baseAnchors[e.activeCurveAnchor.index].offsetY=e.baseAnchors[e.activeCurveAnchor.index].offsetY+a}};document.addEventListener("mouseup",function(){e.captureMouseMove&&(e.resetCurve(),e.activeCurveAnchor=null,o=null,document.removeEventListener("mousemove",t),e.curveAnchors=[],e.curve&&e.curve.remove(),e.lastAnchorAtLength=null,e.lastCurveAnchor=null,e.extendPlanarCurve(),e.captureMouseMove=!1)}),e.curveAnchors.forEach(function(n){e.containerWidth=e.containerWidth>n.data[0]?e.containerWidth:n.data[0],e.svg.attr("width",e.containerWidth),n.anchor=e.DEFAULTS.ShowCurveAnchors&&e.svg.append("circle").attr("cx",n.data[0]).attr("cy",n.data[1]).attr("r",5).attr("fill","#000"),e.DEFAULTS.TouchEditMode&&n.anchor.on("mousedown",function(r){e.activeCurveAnchor=n,o=e.container.node().getBoundingClientRect(),e.captureMouseMove=!0,document.addEventListener("mousemove",t)})}),e.curve&&e.curve.remove();var n=e.curveAnchors.map(function(e){return e.data});e.curve=e.svg.append("path").data([n]).attr("d",d3.line().curve(d3.curveBasis)).attr("stroke-width",2).attr("stroke",e.DEFAULTS.DefaultCurveColor).attr("stroke-dasharray",!0===e.DEFAULTS.DefaultCurveIsSolid?"0, 0":e.DEFAULTS.DefaultCuveStrokeDasharray).attr("fill","none")},e.prototype.drawPlanarMidLine=function(){var e=this;e.planarMidPath=e.svg.append("line").attr("x1",0).attr("y1",e.planarY).attr("x2",e.containerWidth).attr("y2",e.planarY).attr("stroke-width",1).attr("stroke","#e74c3c")},e.prototype.addAnchor=function(e,o){void 0===o&&(o=!0);var t=this,n=new FlowAnchor;n.data=e;var r=!1,a=t.curve.node().getTotalLength();t.lastAnchorAtLength?(t.lastAnchor=t.curve.node().getPointAtLength(t.lastAnchorAtLength),t.lastAnchorAtLength=t.lastAnchorAtLength+t.DEFAULTS.DefaultAnchorNodeSpacing):(t.lastAnchorAtLength=0,t.lastAnchor={x:0,y:0},t.lastAnchorAtLength=t.lastAnchorAtLength+t.DEFAULTS.EventBoxWidth/2);var i;i=t.curve.node().getPointAtLength(t.lastAnchorAtLength);for(var c=t.lastAnchorAlignedLeft?2*t.DEFAULTS.EventBoxWidth+20:t.DEFAULTS.EventBoxWidth+20;i.x-t.DEFAULTS.EventBoxWidth/2<0||i.x-t.lastAnchor.x<=c;)t.lastAnchorAtLength=t.lastAnchorAtLength+10,!r&&t.lastAnchorAtLength>a&&(t.extendPlanarCurve(),r=!0),i=t.curve.node().getPointAtLength(t.lastAnchorAtLength);if(i){n.anchor=i,n.innerNode=t.svg.append("circle").attr("cx",i.x).attr("cy",i.y).attr("r",5).attr("fill",e.nodeColor),n.outerNode=t.svg.append("circle").attr("cx",i.x).attr("cy",i.y).attr("r",10).attr("stroke-width",3).attr("stroke",e.nodeColor).attr("fill","none");var h,s=t.curve.node().getPointAtLength(t.lastAnchorAtLength+1),d=(s.y-i.y)/(s.x-i.x),l=void 0,u="",v=t.DEFAULTS.ShowEventBoxes?t.DEFAULTS.EventBoxHeight+25:t.DEFAULTS.EventBoxHeight+10,A=t.DEFAULTS.ShowEventBoxes?25:10;h=d<0?i.y-v:i.y+A,u=d<0?"top":"bottom",(h+t.DEFAULTS.EventBoxHeight>t.containerHeight||h<0)&&(h=d<0?i.y+A:i.y-v,u=d<0?"bottom":"top"),l=i.x-t.DEFAULTS.EventBoxWidth/2,n.eventBoxLeft=l,t.lastAnchorAlignedLeft=!1,n.eventBoxPosition=u,n.eventBox=t.container.append("div"),n.eventBox.node().classList.add("flow-box-event-container"),n.eventBox.attr("id",GUID()+"_EVB"),n.eventBox.node().style.width=t.DEFAULTS.EventBoxWidth+"px",n.eventBox.node().style.height=t.DEFAULTS.EventBoxHeight+"px",n.eventBox.node().style.top=h+"px",n.eventBox.node().style.left=n.eventBoxLeft+"px",n.upperBox=n.eventBox.append("div"),n.upperBox.node().innerHTML=e.upper,n.lowerBox=n.eventBox.append("div"),n.lowerBox.node().classList.add("flow-box-event-text"),n.lowerBox.node().innerHTML=e.lower;var p=function(e){var o={eventBox:n.eventBox,node:n.data.nodeData};void 0!==t.selectionCallBack&&"function"==typeof t.selectionCallBack&&t.selectionCallBack(o)};if(n.eventBox.on("click",p),t.DEFAULTS.ShowEventBoxes){var f=n.eventBox.append("div");n.eventBox.attr("data-color",e.nodeColor),n.eventBox.node().style.background=LightenDarkenColor(e.nodeColor,120),n.eventBox.node().style.borderColor=e.nodeColor,f.node().classList.add(u+"-side-arrow"),"top"===u?f.node().style.borderTopColor=e.nodeColor:"bottom"===u?f.node().style.borderBottomColor=e.nodeColor:"right"===u&&(f.node().style.borderRightColor=e.nodeColor),n.arrowInBox=f,n.lowerBox.node().style.background=e.nodeColor,n.lowerBox.node().style.color="#FFF"}if(t.anchors.push(n),o){var x=l-150;$(t.container.node()).animate({scrollLeft:x+"px"},300)}}},e.prototype.redraw=function(){var e=this;e.lastAnchorAtLength=null;var o=e.getNodes();e.anchors.forEach(function(e){e.innerNode.remove(),e.outerNode.remove(),e.lowerBox.remove(),e.upperBox.remove(),e.eventBox.remove()}),e.anchors=[],e.initialize(o)},e.prototype.reset=function(){var e=this;e.lastAnchorAtLength=null,e.anchors.forEach(function(e){e.innerNode.remove(),e.outerNode.remove(),e.lowerBox.remove(),e.upperBox.remove(),e.eventBox.remove()}),e.anchors=[],e.curveAnchors.forEach(function(e){e.anchor.remove()}),e.curveAnchors=[],e.initialize([])},e.prototype.getNodes=function(){return this.anchors.map(function(e){return e.data.nodeData})},e.prototype.enableTouchEdit=function(){},e.prototype.highlightNode=function(e){this.anchors.forEach(function(o){o.data.nodeData.id===e.id?(o.eventBox.node().style.outline="2px dotted #000",o.eventBox.node().style.outlineOffset="5px"):o.eventBox.node().style.outline="none"})},e.prototype.removeHighlight=function(e){this.anchors.forEach(function(o){e?o.data.nodeData.id===e.id&&(o.eventBox.node().style.outline="none"):o.eventBox.node().style.outline="none"})},e.prototype.focusNode=function(e){var o=this;o.anchors.forEach(function(t){if(t.data.nodeData.id===e.id){var n=t.eventBoxLeft-150;$(o.container.node()).animate({scrollLeft:n+"px"},300)}})},e.prototype.changeData=function(e){var o=this;o.anchors.forEach(function(t){t.data.nodeData.id===e.id&&(t.data.nodeData=e,t.data.nodeColor=e.nodeColor,t.data.lower=e.lower,t.data.upper=e.upper,t.lowerBox.node().innerHTML=e.lower,o.changeColors(t))})},e.prototype.changeColors=function(e){e.innerNode.attr("fill",e.data.nodeColor),e.outerNode.attr("stroke",e.data.nodeColor),e.eventBox.attr("data-color",e.data.nodeColor),e.eventBox.node().style.background=LightenDarkenColor(e.data.nodeColor,120),e.eventBox.node().style.borderColor=e.data.nodeColor,"top"===e.eventBoxPosition?e.arrowInBox.node().style.borderTopColor=e.data.nodeColor:"bottom"===e.eventBoxPosition?e.arrowInBox.node().style.borderBottomColor=e.data.nodeColor:"right"===e.eventBoxPosition&&(e.arrowInBox.node().style.borderRightColor=e.data.nodeColor),e.lowerBox.node().style.background=e.data.nodeColor},e}();