function LightenDarkenColor(e,t){var o=!1;"#"==e[0]&&(e=e.slice(1),o=!0);var n=parseInt(e,16),r=(n>>16)+t;r>255?r=255:r<0&&(r=0);var a=(n>>8&255)+t;a>255?a=255:a<0&&(a=0);var c=(255&n)+t;return c>255?c=255:c<0&&(c=0),(o?"#":"")+(c|a<<8|r<<16).toString(16)}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function GUID(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+"-"+e()}var FLOW_DEFAULTS={DefaultAnchorNodeSpacing:10,DefaultCurveColor:"#6dc1ff",ShowPlanarMid:!1,ShowCurveAnchors:!1,DefaultNodeColor:"#007c6",DefaultContainerHeightFraction:1,ShowEventBoxes:!0,DefaultCurveIsSolid:!1,DefaultCuveStrokeDasharray:"2, 2",TouchEditMode:!1,EventBoxHeight:120,EventBoxWidth:180,BaseAnchors:[]},FlowBoxNode=function(){return function(e){this.nodeData=e,this.lower=e.lower,this.upper=e.upper,this.nodeColor=e.nodeColor}}(),FlowAnchor=function(){return function(){}}(),CurveAnchor=function(){return function(){this.index=-1}}(),AnchorBase=function(){return function(e,t){this.offsetX=0,this.offsetY=0,this.offsetX=e,this.offsetY=t}}(),FlowBox=function(){function e(e,t,o,n){this.anchors=[],this.lastAnchorAtLength=null,this.curveAnchors=[],this.lastCurveAnchor=null;var r=this;r.selectionCallBack=n,r.baseAnchors=[],r.DEFAULTS=e,r.container=d3.select(document.getElementById(t)),r.container.node().classList.add("flow-box-container");var a=r.container.node().getBoundingClientRect().width;r.containerWidth=a;var c=window.innerHeight;1!==r.DEFAULTS.DefaultContainerHeightFraction?(r.containerHeight=c*r.DEFAULTS.DefaultContainerHeightFraction,r.container.node().style.height=r.containerHeight+"px"):r.containerHeight=r.container.node().getBoundingClientRect().height,r.planarY=.5*r.containerHeight,setTimeout(function(){r.svg=r.container.append("svg").attr("width",a).attr("height",r.containerHeight),setTimeout(function(){r.populateCurveAnchorBase(),r.extendPlanarCurve(),r.initialize(o)})})}return e.prototype.resetCurve=function(){var e=this;e.curveAnchors.forEach(function(e){e.anchor.remove()}),e.curveAnchors=[],e.curve&&e.curve.remove()},e.prototype.initialize=function(e){var t=this;t.svg.empty(),t.DEFAULTS.ShowPlanarMid&&t.drawPlanarMidLine(),t.initNodes(e)},e.prototype.initNodes=function(e){var t=this;e.forEach(function(e){var o=new FlowBoxNode(e);t.addAnchor(o,!1)})},e.prototype.getBaseAnchors=function(){return this.DEFAULTS.BaseAnchors},e.prototype.populateCurveAnchorBase=function(){var e=this,t=e.containerHeight/5;e.baseAnchors=[],e.DEFAULTS.BaseAnchors&&e.DEFAULTS.BaseAnchors.length>0?e.DEFAULTS.BaseAnchors.push():(e.DEFAULTS.BaseAnchors.push([0,100]),e.DEFAULTS.BaseAnchors.push([200,1*-t]),e.DEFAULTS.BaseAnchors.push([300,2*-t]),e.DEFAULTS.BaseAnchors.push([50,1.5*t]),e.DEFAULTS.BaseAnchors.push([200,1.7*t]),e.DEFAULTS.BaseAnchors.push([200,1.5*-t]),e.DEFAULTS.BaseAnchors.push([200,1.7*-t]),e.DEFAULTS.BaseAnchors.push([50,1*t]),e.DEFAULTS.BaseAnchors.push([150,1.5*t]),e.DEFAULTS.BaseAnchors.push([200,0])),e.DEFAULTS.BaseAnchors.forEach(function(t){e.baseAnchors.push(new AnchorBase(t[0],t[1]))})},e.prototype.extendPlanarCurve=function(){var e=this;null==e.lastCurveAnchor&&(e.lastCurveAnchor=[0,0]),e.baseAnchors.forEach(function(t,o){e.creatCurveAnchor(o+1,t)}),e.drawPlanarCurve()},e.prototype.creatCurveAnchor=function(e,t){var o=this,n=new CurveAnchor;n.index=e,n.anchorBase=t;var r=o.lastCurveAnchor[0]+t.offsetX,a=o.planarY+t.offsetY;n.data=[r,a],o.lastCurveAnchor=[r,a],o.curveAnchors.push(n)},e.prototype.drawPlanarCurve=function(){var e=this,t=null;e.captureMouseMove=!1;var o=function(o){if(e.activeCurveAnchor&&t){var n=o.clientX-t.left,r=o.clientY-t.top;e.activeCurveAnchor.anchor.attr("cx",n),e.activeCurveAnchor.anchor.attr("cy",r);var a=n-e.activeCurveAnchor.data[0];e.baseAnchors[e.activeCurveAnchor.index].offsetX=e.baseAnchors[e.activeCurveAnchor.index].offsetX+a,a=r-e.activeCurveAnchor.data[1],e.baseAnchors[e.activeCurveAnchor.index].offsetY=e.baseAnchors[e.activeCurveAnchor.index].offsetY+a}};document.addEventListener("mouseup",function(){e.captureMouseMove&&(e.resetCurve(),e.activeCurveAnchor=null,t=null,document.removeEventListener("mousemove",o),e.curveAnchors=[],e.curve&&e.curve.remove(),e.lastAnchorAtLength=null,e.lastCurveAnchor=null,e.extendPlanarCurve(),e.captureMouseMove=!1)}),e.curveAnchors.forEach(function(n){e.containerWidth=e.containerWidth>n.data[0]?e.containerWidth:n.data[0],e.svg.attr("width",e.containerWidth),n.anchor=e.DEFAULTS.ShowCurveAnchors&&e.svg.append("circle").attr("cx",n.data[0]).attr("cy",n.data[1]).attr("r",5).attr("fill","#000"),e.DEFAULTS.TouchEditMode&&n.anchor.on("mousedown",function(r){e.activeCurveAnchor=n,t=e.container.node().getBoundingClientRect(),e.captureMouseMove=!0,document.addEventListener("mousemove",o)})}),e.curve&&e.curve.remove();var n=e.curveAnchors.map(function(e){return e.data});e.curve=e.svg.append("path").data([n]).attr("d",d3.line().curve(d3.curveBasis)).attr("stroke-width",2).attr("stroke",e.DEFAULTS.DefaultCurveColor).attr("stroke-dasharray",!0===e.DEFAULTS.DefaultCurveIsSolid?"0, 0":e.DEFAULTS.DefaultCuveStrokeDasharray).attr("fill","none")},e.prototype.drawPlanarMidLine=function(){var e=this;e.planarMidPath=e.svg.append("line").attr("x1",0).attr("y1",e.planarY).attr("x2",e.containerWidth).attr("y2",e.planarY).attr("stroke-width",1).attr("stroke","#e74c3c")},e.prototype.addAnchor=function(e,t){void 0===t&&(t=!0);var o=this,n=new FlowAnchor;n.data=e;var r=!1,a=o.curve.node().getTotalLength();o.lastAnchorAtLength?(o.lastAnchor=o.curve.node().getPointAtLength(o.lastAnchorAtLength),o.lastAnchorAtLength=o.lastAnchorAtLength+o.DEFAULTS.DefaultAnchorNodeSpacing):(o.lastAnchorAtLength=0,o.lastAnchor={x:0,y:0},o.lastAnchorAtLength=o.lastAnchorAtLength+o.DEFAULTS.EventBoxWidth/2);var c;c=o.curve.node().getPointAtLength(o.lastAnchorAtLength);for(var i=o.lastAnchorAlignedLeft?2*o.DEFAULTS.EventBoxWidth+20:o.DEFAULTS.EventBoxWidth+20;c.x-o.DEFAULTS.EventBoxWidth/2<0||c.x-o.lastAnchor.x<=i;)o.lastAnchorAtLength=o.lastAnchorAtLength+10,!r&&o.lastAnchorAtLength>a&&(o.extendPlanarCurve(),r=!0),c=o.curve.node().getPointAtLength(o.lastAnchorAtLength);if(c){n.anchor=c,n.innerNode=o.svg.append("circle").attr("cx",c.x).attr("cy",c.y).attr("r",5).attr("fill",e.nodeColor),n.outerNode=o.svg.append("circle").attr("cx",c.x).attr("cy",c.y).attr("r",10).attr("stroke-width",3).attr("stroke",e.nodeColor).attr("fill","none");var h,s=o.curve.node().getPointAtLength(o.lastAnchorAtLength+1),u=(s.y-c.y)/(s.x-c.x),v=void 0,l="",d=o.DEFAULTS.ShowEventBoxes?o.DEFAULTS.EventBoxHeight+25:o.DEFAULTS.EventBoxHeight+10,A=o.DEFAULTS.ShowEventBoxes?25:10;h=u<0?c.y-d:c.y+A,l=u<0?"top":"bottom",(h+o.DEFAULTS.EventBoxHeight>o.containerHeight||h<0)&&(h=u<0?c.y+A:c.y-d,l=u<0?"bottom":"top"),v=c.x-o.DEFAULTS.EventBoxWidth/2,o.lastAnchorAlignedLeft=!1,n.eventBoxPosition=l,n.eventBox=o.container.append("div"),n.eventBox.node().classList.add("flow-box-event-container"),n.eventBox.attr("id",GUID()+"_EVB"),n.eventBox.node().style.width=o.DEFAULTS.EventBoxWidth+"px",n.eventBox.node().style.height=o.DEFAULTS.EventBoxHeight+"px",n.eventBox.node().style.top=h+"px",n.eventBox.node().style.left=v+"px",n.upperBox=n.eventBox.append("div"),n.upperBox.node().innerHTML=e.upper,n.lowerBox=n.eventBox.append("div"),n.lowerBox.node().classList.add("flow-box-event-text"),n.lowerBox.node().innerHTML=e.lower;var p=function(e){var t={eventBox:n.eventBox,node:n.data.nodeData};void 0!==o.selectionCallBack&&"function"==typeof o.selectionCallBack&&o.selectionCallBack(t)};if(n.eventBox.on("click",p),o.DEFAULTS.ShowEventBoxes){var f=n.eventBox.append("div");n.eventBox.attr("data-color",e.nodeColor),n.eventBox.node().style.background=LightenDarkenColor(e.nodeColor,120),n.eventBox.node().style.borderColor=e.nodeColor,f.node().classList.add(l+"-side-arrow"),"top"===l?f.node().style.borderTopColor=e.nodeColor:"bottom"===l?f.node().style.borderBottomColor=e.nodeColor:"right"===l&&(f.node().style.borderRightColor=e.nodeColor),n.lowerBox.node().style.background=e.nodeColor,n.lowerBox.node().style.color="#FFF"}if(o.anchors.push(n),t){var x=v-150;$(o.container.node()).animate({scrollLeft:x+"px"},300)}}},e.prototype.redraw=function(){var e=this;e.lastAnchorAtLength=null;var t=e.getNodes();e.anchors.forEach(function(e){e.innerNode.remove(),e.outerNode.remove(),e.lowerBox.remove(),e.upperBox.remove(),e.eventBox.remove()}),e.anchors=[],e.initialize(t)},e.prototype.reset=function(){var e=this;e.lastAnchorAtLength=null,e.anchors.forEach(function(e){e.innerNode.remove(),e.outerNode.remove(),e.lowerBox.remove(),e.upperBox.remove(),e.eventBox.remove()}),e.anchors=[],e.curveAnchors.forEach(function(e){e.anchor.remove()}),e.curveAnchors=[],e.initialize([])},e.prototype.getNodes=function(){return this.anchors.map(function(e){return e.data.nodeData})},e.prototype.enableTouchEdit=function(){},e}();