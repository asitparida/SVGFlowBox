function debounce(o,t,e){var n;return function(){var r=this,a=arguments,i=e&&!n;clearTimeout(n),n=setTimeout(function(){n=null,e||o.apply(r,a)},t),i&&o.apply(r,a)}}function LightenDarkenColor(o,t){var e=!1;"#"==o[0]&&(o=o.slice(1),e=!0);var n=parseInt(o,16),r=(n>>16)+t;r>255?r=255:r<0&&(r=0);var a=(n>>8&255)+t;a>255?a=255:a<0&&(a=0);var i=(255&n)+t;return i>255?i=255:i<0&&(i=0),(e?"#":"")+(i|a<<8|r<<16).toString(16)}function hexToRgb(o){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function GUID(){function o(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return o()+"-"+o()}var FLOW_DEFAULTS={DefaultAnchorNodeSpacing:10,DefaultCurveColor:"#6dc1ff",ShowPlanarMid:!1,ShowCurveAnchors:!1,DefaultNodeColor:"#007c6",DefaultContainerHeightFraction:1,ShowEventBoxes:!0,DefaultCurveIsSolid:!1,DefaultCuveStrokeDasharray:"2, 2",TouchEditMode:!1,EventBoxHeight:120,EventBoxWidth:180,BaseAnchors:[],EditBaseDistanceChange:4},FlowBoxNode=function(){return function(o){this.eventBoxPosition=null,this.nodeData=o,this.eventBoxPosition=o.eventBoxPosition||null,this.lower=o.lower,this.upper=o.upper,this.nodeColor=o.nodeColor,void 0===this.nodeData.id&&(this.nodeData.id=GUID())}}(),FlowAnchor=function(){return function(){}}(),CurveAnchor=function(){return function(){this.index=-1}}(),AnchorBase=function(){return function(o,t){this.offsetX=0,this.offsetY=0,this.offsetX=o,this.offsetY=t}}(),FlowBox=function(){function o(o,t,e,n,r){void 0===r&&(r=!1),this.anchors=[],this.lastAnchorAtLength=null,this.curveAnchors=[],this.lastCurveAnchor=null,this.useDataPostions=!1,this.editingBoxPositionInTouchMode=!1,this.lastBoxPositionX=0;var a=this;a.useDataPostions=r,a.selectionCallBack=n,a.baseAnchors=[],a.DEFAULTS=o,a.container=d3.select(document.getElementById(t)),a.container.node().classList.add("flow-box-container");var i=a.container.node().getBoundingClientRect().width;a.containerWidth=i;var c=window.innerHeight;1!==a.DEFAULTS.DefaultContainerHeightFraction?(a.containerHeight=c*a.DEFAULTS.DefaultContainerHeightFraction,a.container.node().style.height=a.containerHeight+"px"):a.containerHeight=a.container.node().getBoundingClientRect().height,a.planarY=.5*a.containerHeight,setTimeout(function(){a.svg=a.container.append("svg").attr("width",i).attr("height",a.containerHeight),setTimeout(function(){a.populateCurveAnchorBase(),a.extendPlanarCurve(),a.initialize(e)})})}return o.prototype.resetCurve=function(){var o=this;o.curveAnchors.forEach(function(o){o.anchor.remove()}),o.curveAnchors=[],o.curve&&o.curve.remove()},o.prototype.initialize=function(o){var t=this;t.svg.empty(),t.DEFAULTS.ShowPlanarMid&&t.drawPlanarMidLine(),t.initNodes(o)},o.prototype.initNodes=function(o){var t=this;o.forEach(function(o){var e=new FlowBoxNode(o);t.addAnchor(e,!1)})},o.prototype.getBaseAnchors=function(){return this.DEFAULTS.BaseAnchors},o.prototype.populateCurveAnchorBase=function(){var o=this,t=o.containerHeight/5;o.baseAnchors=[],o.DEFAULTS.BaseAnchors&&o.DEFAULTS.BaseAnchors.length>0?o.DEFAULTS.BaseAnchors.push():(o.DEFAULTS.BaseAnchors.push([0,0]),o.DEFAULTS.BaseAnchors.push([100,-t]),o.DEFAULTS.BaseAnchors.push([200,-t]),o.DEFAULTS.BaseAnchors.push([100,0]),o.DEFAULTS.BaseAnchors.push([100,+t]),o.DEFAULTS.BaseAnchors.push([200,+t]),o.DEFAULTS.BaseAnchors.push([100,0]),o.DEFAULTS.BaseAnchors.push([100,-t]),o.DEFAULTS.BaseAnchors.push([200,-t]),o.DEFAULTS.BaseAnchors.push([100,0]),o.DEFAULTS.BaseAnchors.push([100,+t]),o.DEFAULTS.BaseAnchors.push([200,+t]),o.DEFAULTS.BaseAnchors.push([100,0]),o.DEFAULTS.BaseAnchors.push([100,-t]),o.DEFAULTS.BaseAnchors.push([200,-t]),o.DEFAULTS.BaseAnchors.push([100,0]),o.DEFAULTS.BaseAnchors.push([100,+t]),o.DEFAULTS.BaseAnchors.push([200,+t]),o.DEFAULTS.BaseAnchors.push([100,0])),o.DEFAULTS.BaseAnchors.forEach(function(t){o.baseAnchors.push(new AnchorBase(t[0],t[1]))})},o.prototype.extendPlanarCurve=function(){var o=this;null==o.lastCurveAnchor&&(o.lastCurveAnchor=[0,0]),o.baseAnchors.forEach(function(t,e){o.creatCurveAnchor(e+1,t)}),o.drawPlanarCurve()},o.prototype.creatCurveAnchor=function(o,t){var e=this,n=new CurveAnchor;n.index=o,n.anchorBase=t;var r=e.lastCurveAnchor[0]+t.offsetX,a=e.planarY+t.offsetY;n.data=[r,a],e.lastCurveAnchor=[r,a],e.curveAnchors.push(n)},o.prototype.drawPlanarCurve=function(){var o=this;o.captureMouseMove=!1,o.curveAnchors.forEach(function(t){o.containerWidth=o.containerWidth>t.data[0]?o.containerWidth:t.data[0],o.svg.attr("width",o.containerWidth),t.anchor=o.DEFAULTS.ShowCurveAnchors&&o.svg.append("circle").attr("cx",t.data[0]).attr("cy",t.data[1]).attr("r",5).attr("fill","#000")}),o.curve&&o.curve.remove();var t=o.curveAnchors.map(function(o){return o.data});o.curve=o.svg.append("path").data([t]).attr("d",d3.line().curve(d3.curveNatural)).attr("stroke-width",2).attr("stroke",o.DEFAULTS.DefaultCurveColor).attr("stroke-dasharray",!0===o.DEFAULTS.DefaultCurveIsSolid?"0, 0":o.DEFAULTS.DefaultCuveStrokeDasharray).attr("fill","none")},o.prototype.drawPlanarMidLine=function(){var o=this;o.planarMidPath=o.svg.append("line").attr("x1",0).attr("y1",o.planarY).attr("x2",o.containerWidth).attr("y2",o.planarY).attr("stroke-width",1).attr("stroke","#e74c3c")},o.prototype.addAnchor=function(o,t){void 0===t&&(t=!0);var e=this,n=new FlowAnchor;n.data=o;var r,a=!1,i=e.curve.node().getTotalLength();if(e.useDataPostions)e.lastAnchorAtLength||(e.lastAnchorAtLength=0),e.lastAnchorAtLength=e.lastAnchorAtLength+o.nodeData.diff,r=e.curve.node().getPointAtLength(e.lastAnchorAtLength),!a&&(e.lastAnchorAtLength>i||e.lastAnchorAtLength+e.DEFAULTS.EventBoxWidth/2+50>i)&&(e.extendPlanarCurve(),a=!0);else{e.lastAnchorAtLength?(e.lastAnchor=e.curve.node().getPointAtLength(e.lastAnchorAtLength),e.lastAnchorAtLength=e.lastAnchorAtLength+e.DEFAULTS.DefaultAnchorNodeSpacing):(e.lastAnchorAtLength=0,e.lastAnchor={x:0,y:0},e.lastAnchorAtLength=e.lastAnchorAtLength+e.DEFAULTS.EventBoxWidth/2),r=e.curve.node().getPointAtLength(e.lastAnchorAtLength);for(var c=e.lastAnchorAlignedLeft?2*e.DEFAULTS.EventBoxWidth+20:e.DEFAULTS.EventBoxWidth+20;r.x-e.DEFAULTS.EventBoxWidth/2<0||r.x-e.lastAnchor.x<=c;)e.lastAnchorAtLength=e.lastAnchorAtLength+10,!a&&e.lastAnchorAtLength>i&&(e.extendPlanarCurve(),a=!0),r=e.curve.node().getPointAtLength(e.lastAnchorAtLength)}if(r){n.anchor=r,n.anchorDistance=e.lastAnchorAtLength,n.innerNode=e.svg.append("circle").attr("cx",r.x).attr("cy",r.y).attr("r",5).attr("fill",o.nodeColor),n.outerNode=e.svg.append("circle").attr("cx",r.x).attr("cy",r.y).attr("r",10).attr("stroke-width",3).attr("stroke",o.nodeColor).attr("fill","none");var s,d=e.curve.node().getPointAtLength(e.lastAnchorAtLength+1),h=(d.y-r.y)/(d.x-r.x),l=void 0,v="",u=e.DEFAULTS.ShowEventBoxes?e.DEFAULTS.EventBoxHeight+25:e.DEFAULTS.EventBoxHeight+10,A=e.DEFAULTS.ShowEventBoxes?25:10;null===o.eventBoxPosition?(s=h<0?r.y-u:r.y+A,v=h<0?"top":"bottom",(s+e.DEFAULTS.EventBoxHeight>e.containerHeight||s<0)&&(s=h<0?r.y+A:r.y-u,v=h<0?"bottom":"top")):"bottom"===o.eventBoxPosition?(s=r.y+A,v="bottom"):(s=r.y-u,v="top"),l=r.x-e.DEFAULTS.EventBoxWidth/2,n.eventBoxLeft=l,e.lastAnchorAlignedLeft=!1,n.eventBoxPosition=v,n.eventBox=e.container.append("div"),n.eventBox.attr("tabindex",0),n.eventBox.node().classList.add("flow-box-event-container"),n.eventBox.attr("id",GUID()+"_EVB"),n.eventBox.node().style.width=e.DEFAULTS.EventBoxWidth+"px",n.eventBox.node().style.height=e.DEFAULTS.EventBoxHeight+"px",n.eventBox.node().style.top=s+"px",n.eventBox.node().style.left=n.eventBoxLeft+"px",n.upperBox=n.eventBox.append("div"),n.upperBox.node().innerHTML=o.upper,n.lowerBox=n.eventBox.append("div"),n.lowerBox.node().classList.add("flow-box-event-text"),n.lowerBox.node().innerHTML=o.lower;var p=function(o){var t={eventBox:n.eventBox,node:n.data.nodeData};1==e.editingBoxPositionInTouchMode?(e.activeFlowAnchor=n,e.highlightNode(n.data.nodeData)):void 0!==e.selectionCallBack&&"function"==typeof e.selectionCallBack&&e.selectionCallBack(t)};if(n.eventBox.on("click",p),e.DEFAULTS.ShowEventBoxes){var B=n.eventBox.append("div");n.eventBox.attr("data-color",o.nodeColor),n.eventBox.node().style.background=LightenDarkenColor(o.nodeColor,120),n.eventBox.node().style.borderColor=o.nodeColor,B.node().style.borderTopColor="transparent",B.node().style.borderBottomColor="transparent",B.node().style.borderRightColor="transparent",B.node().classList.add(v+"-side-arrow"),"top"===v?B.node().style.borderTopColor=o.nodeColor:"bottom"===v?B.node().style.borderBottomColor=o.nodeColor:"right"===v&&(B.node().style.borderRightColor=o.nodeColor),n.arrowInBox=B,n.lowerBox.node().style.background=o.nodeColor,n.lowerBox.node().style.color="#FFF"}if(e.anchors.push(n),t){var x=l-150;$(e.container.node()).animate({scrollLeft:x+"px"},300)}var f=function(){if(e.editingBoxPositionInTouchMode&&e.activeFlowAnchor.data.nodeData.id===n.data.nodeData.id){var o=e.DEFAULTS.EditBaseDistanceChange;return d3.event.ctrlKey&&(o*=3),39==d3.event.keyCode?e.moveActiveNode(o):37==d3.event.keyCode?e.moveActiveNode(-o):38==d3.event.keyCode?e.adjustEventBoxPosition("top"):40==d3.event.keyCode&&e.adjustEventBoxPosition("bottom"),d3.event.stopPropagation(),d3.event.preventDefault(),!1}};n.eventBox.on("keyup",function(){f()});var g=function(){var o=!1;if(e.editingBoxPositionInTouchMode&&e.activeFlowAnchor.data.nodeData.id===n.data.nodeData.id&&(39==d3.event.keyCode?o=!0:37==d3.event.keyCode&&(o=!0)),o)return d3.event.stopPropagation(),d3.event.preventDefault(),!1};n.eventBox.on("keydown",function(){g()})}},o.prototype.adjustEventBoxPosition=function(o){void 0===o&&(o=null);var t,e,n=this,r=n.activeFlowAnchor.anchor,a=n.curve.node().getPointAtLength(n.lastAnchorAtLength+1),i=(a.y-r.y)/(a.x-r.x),c="",s=n.DEFAULTS.ShowEventBoxes?n.DEFAULTS.EventBoxHeight+25:n.DEFAULTS.EventBoxHeight+10,d=n.DEFAULTS.ShowEventBoxes?25:10;null===o?(t=i<0?r.y-s:r.y+d,c=i<0?"top":"bottom",(t+n.DEFAULTS.EventBoxHeight>n.containerHeight||t<0)&&(t=i<0?r.y+d:r.y-s,c=i<0?"bottom":"top")):"bottom"===o?(t=r.y+d,c="bottom"):(t=r.y-s,c="top"),e=r.x-n.DEFAULTS.EventBoxWidth/2,n.activeFlowAnchor.eventBoxLeft=e,n.lastAnchorAlignedLeft=!1,n.activeFlowAnchor.data.eventBoxPosition=c,n.activeFlowAnchor.data.nodeData.eventBoxPosition=c,n.activeFlowAnchor.eventBoxPosition=c,n.activeFlowAnchor.eventBox.node().style.top=t+"px",n.activeFlowAnchor.eventBox.node().style.left=n.activeFlowAnchor.eventBoxLeft+"px",n.activeFlowAnchor.arrowInBox.node().classList.remove("top-side-arrow"),n.activeFlowAnchor.arrowInBox.node().classList.remove("bottom-side-arrow"),n.activeFlowAnchor.arrowInBox.node().classList.add(c+"-side-arrow"),n.activeFlowAnchor.arrowInBox.node().style.borderTopColor="transparent",n.activeFlowAnchor.arrowInBox.node().style.borderBottomColor="transparent",n.activeFlowAnchor.arrowInBox.node().style.borderRightColor="transparent","top"===c?n.activeFlowAnchor.arrowInBox.node().style.borderTopColor=n.activeFlowAnchor.data.nodeData.nodeColor:"bottom"===c?n.activeFlowAnchor.arrowInBox.node().style.borderBottomColor=n.activeFlowAnchor.data.nodeData.nodeColor:"right"===c&&(n.activeFlowAnchor.arrowInBox.node().style.borderRightColor=n.activeFlowAnchor.data.nodeData.nodeColor)},o.prototype.moveActiveNode=function(o){var t=this,e=t.activeFlowAnchor.anchorDistance+o,n=t.curve.node().getPointAtLength(e),r=n.x,a=n.y;t.activeFlowAnchor.innerNode.attr("cx",r),t.activeFlowAnchor.outerNode.attr("cx",r),t.activeFlowAnchor.innerNode.attr("cy",a),t.activeFlowAnchor.outerNode.attr("cy",a),t.activeFlowAnchor.anchor=n,t.activeFlowAnchor.anchorDistance=e,t.adjustEventBoxPosition()},o.prototype.redraw=function(){var o=this;o.lastAnchorAtLength=null;var t=o.getNodes();o.anchors.forEach(function(o){o.innerNode.remove(),o.outerNode.remove(),o.lowerBox.remove(),o.upperBox.remove(),o.eventBox.remove()}),o.anchors=[],o.initialize(t)},o.prototype.reset=function(){var o=this;o.lastAnchorAtLength=null,o.anchors.forEach(function(o){o.innerNode.remove(),o.outerNode.remove(),o.lowerBox.remove(),o.upperBox.remove(),o.eventBox.remove()}),o.anchors=[],o.curveAnchors.forEach(function(o){o.anchor.remove()}),o.curveAnchors=[],o.initialize([])},o.prototype.getNodes=function(){var o=this,t=0;return o.anchors.forEach(function(o){o.data.nodeData.diff=o.anchorDistance-t,o.data.nodeData.eventBoxPosition=o.eventBoxPosition,t=o.anchorDistance}),o.anchors.map(function(o){return o.data.nodeData})},o.prototype.enableTouchEdit=function(){var o=this;o.editingBoxPositionInTouchMode?o.editingBoxPositionInTouchMode=!1:(o.editingBoxPositionInTouchMode=!0,o.removeHighlight())},o.prototype.highlightNode=function(o){this.anchors.forEach(function(t){t.data.nodeData.id===o.id?(t.eventBox.node().style.outline="2px dotted #000",t.eventBox.node().style.outlineOffset="5px"):t.eventBox.node().style.outline="none"})},o.prototype.removeHighlight=function(o){this.anchors.forEach(function(t){o?t.data.nodeData.id===o.id&&(t.eventBox.node().style.outline="none"):t.eventBox.node().style.outline="none"})},o.prototype.focusNode=function(o){var t=this;t.anchors.forEach(function(e){if(e.data.nodeData.id===o.id){var n=e.eventBoxLeft-150;$(t.container.node()).animate({scrollLeft:n+"px"},300)}})},o.prototype.changeData=function(o){var t=this;t.anchors.forEach(function(e){e.data.nodeData.id===o.id&&(e.data.nodeData=o,e.data.nodeColor=o.nodeColor,e.data.lower=o.lower,e.data.upper=o.upper,e.data.eventBoxPosition=o.eventBoxPosition,t.activeFlowAnchor=e,t.adjustEventBoxPosition(e.data.eventBoxPosition),e.lowerBox.node().innerHTML=o.lower,e.upperBox.node().innerHTML=o.upper,t.changeColors(e))})},o.prototype.changeColors=function(o){o.innerNode.attr("fill",o.data.nodeColor),o.outerNode.attr("stroke",o.data.nodeColor),o.eventBox.attr("data-color",o.data.nodeColor),o.eventBox.node().style.background=LightenDarkenColor(o.data.nodeColor,120),o.eventBox.node().style.borderColor=o.data.nodeColor,"top"===o.eventBoxPosition?o.arrowInBox.node().style.borderTopColor=o.data.nodeColor:"bottom"===o.eventBoxPosition?o.arrowInBox.node().style.borderBottomColor=o.data.nodeColor:"right"===o.eventBoxPosition&&(o.arrowInBox.node().style.borderRightColor=o.data.nodeColor),o.lowerBox.node().style.background=o.data.nodeColor},o.prototype.swapNodes=function(o,t){var e=this,n=null,r=null;e.anchors.forEach(function(e){if(e.data.nodeData.id===o.id)(a=Object.assign({},e.data.nodeData)).lower=t.lower,a.upper=t.upper,a.nodeColor=t.nodeColor,a.eventBoxPosition=t.eventBoxPosition,n=a;else if(e.data.nodeData.id===t.id){var a=Object.assign({},e.data.nodeData);a.lower=o.lower,a.upper=o.upper,a.nodeColor=o.nodeColor,a.eventBoxPosition=o.eventBoxPosition,r=a}}),n&&e.changeData(n),r&&e.changeData(r)},o.prototype.deleteNode=function(o){var t=this,e=null,n=null,r=[];t.anchors.forEach(function(t,e){t.data.nodeData.id===o.id&&(n=e)}),n>=0&&(e=t.anchors[n-1],t.anchors.forEach(function(o,t){t>=n&&(o.innerNode.remove(),o.outerNode.remove(),o.lowerBox.remove(),o.upperBox.remove(),o.eventBox.remove(),o.arrowInBox.remove()),t>n&&r.push(o.data)}),t.anchors=t.anchors.filter(function(o,t){return t<n}),t.lastAnchorAtLength=e?e.anchorDistance:0,r.forEach(function(o){t.addAnchor(o,!1)}))},o}();