function LightenDarkenColor(t,e){var n=!1;"#"==t[0]&&(t=t.slice(1),n=!0);var o=parseInt(t,16),r=(o>>16)+e;r>255?r=255:r<0&&(r=0);var a=(o>>8&255)+e;a>255?a=255:a<0&&(a=0);var i=(255&o)+e;return i>255?i=255:i<0&&(i=0),(n?"#":"")+(i|a<<8|r<<16).toString(16)}function hexToRgb(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}var FLOW_DEFAULTS={DefaultAnchorNodeSpacing:50,DefaultCurveColor:"#6dc1ff",ShowPlanarMid:!1,ShowCurveAnchors:!1,DefaultNodeColor:"#007c6",DefaultContainerHeightFraction:1,ShowEventBoxes:!0,DefaultCurveIsSolid:!1,DefaultCuveStrokeDasharray:"2, 2"},FlowBoxNode=function(){return function(t,e,n){void 0===t&&(t=""),void 0===e&&(e=""),void 0===n&&(n=FLOW_DEFAULTS.DefaultNodeColor),this.lower=t,this.upper=e,this.nodeColor=n}}(),FlowAnchor=function(){return function(){}}(),FlowBox=function(){function t(t,e,n){this.anchors=[],this.lastAnchorAtLength=null,this.curveAnchors=[],this.lastCurveAnchor=null;var o=this;o.DEFAULTS=t,o.container=d3.select(document.getElementById(e)),o.container.node().classList.add("flow-box-container");var r=o.container.node().getBoundingClientRect().width;o.containerWidth=r;var a=window.innerHeight;1!==o.DEFAULTS.DefaultContainerHeightFraction?(o.containerHeight=a*o.DEFAULTS.DefaultContainerHeightFraction,o.container.node().style.height=o.containerHeight+"px"):o.containerHeight=o.container.node().getBoundingClientRect().height,o.planarY=.5*o.containerHeight,setTimeout(function(){o.svg=o.container.append("svg").attr("width",r).attr("height",o.containerHeight),setTimeout(function(){o.initialize(n)})})}return t.prototype.initialize=function(t){var e=this;e.svg.empty(),e.extendPlanarCurve(),e.DEFAULTS.ShowPlanarMid&&e.drawPlanarMidLine(),e.initNodes(t)},t.prototype.initNodes=function(t){var e=this;t.forEach(function(t){e.addAnchor(t)})},t.prototype.extendPlanarCurve=function(){var t=this;null==t.lastCurveAnchor&&(t.curveAnchors.push([0,t.planarY+100]),t.lastCurveAnchor=[0,t.planarY+100]);var e=t.containerHeight/5;t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY-1*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+300,t.planarY-2*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+50,t.planarY+1.5*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY+1.7*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY-1.5*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY-1.7*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+50,t.planarY+e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+150,t.planarY+1.5*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY),t.drawPlanarCurve()},t.prototype.insertIntoCurveAnchor=function(t,e){var n=this;n.curveAnchors.push([t,e]),n.lastCurveAnchor=[t,e]},t.prototype.drawPlanarCurve=function(){var t=this;t.curveAnchors.forEach(function(e){t.containerWidth=t.containerWidth>e[0]?t.containerWidth:e[0],t.svg.attr("width",t.containerWidth),t.DEFAULTS.ShowCurveAnchors&&t.svg.append("circle").attr("cx",e[0]).attr("cy",e[1]).attr("r",5).attr("fill","#000")}),t.curve&&t.curve.remove(),t.curve=t.svg.append("path").data([t.curveAnchors]).attr("d",d3.line().curve(d3.curveBasis)).attr("stroke-width",2).attr("stroke",t.DEFAULTS.DefaultCurveColor).attr("stroke-dasharray",!0===t.DEFAULTS.DefaultCurveIsSolid?"0, 0":t.DEFAULTS.DefaultCuveStrokeDasharray).attr("fill","none")},t.prototype.drawPlanarMidLine=function(){var t=this;t.planarMidPath=t.svg.append("line").attr("x1",0).attr("y1",t.planarY).attr("x2",t.containerWidth).attr("y2",t.planarY).attr("stroke-width",1).attr("stroke","#e74c3c")},t.prototype.addAnchor=function(t){var e=this,n=new FlowAnchor;n.data=t;var o=!1,r=e.curve.node().getTotalLength();e.lastAnchorAtLength?(e.lastAnchor=e.curve.node().getPointAtLength(e.lastAnchorAtLength),e.lastAnchorAtLength=e.lastAnchorAtLength+e.DEFAULTS.DefaultAnchorNodeSpacing):(e.lastAnchorAtLength=0,e.lastAnchor={x:-50,y:0},e.lastAnchorAtLength=e.lastAnchorAtLength+100);var a;if(a=e.curve.node().getPointAtLength(e.lastAnchorAtLength),Math.abs(a.y-e.lastAnchor.y)<100)for(var i=e.lastAnchorAlignedLeft?220:130;a.x-e.lastAnchor.x<=i;)e.lastAnchorAtLength=e.lastAnchorAtLength+25,!o&&e.lastAnchorAtLength>r&&(e.extendPlanarCurve(),o=!0),a=e.curve.node().getPointAtLength(e.lastAnchorAtLength);if(a){n.anchor=a,n.innerNode=e.svg.append("circle").attr("cx",a.x).attr("cy",a.y).attr("r",5).attr("fill",t.nodeColor),n.outerNode=e.svg.append("circle").attr("cx",a.x).attr("cy",a.y).attr("r",10).attr("stroke-width",3).attr("stroke",t.nodeColor).attr("fill","none");var l,c=e.curve.node().getPointAtLength(e.lastAnchorAtLength+1),h=(c.y-a.y)/(c.x-a.x),s=void 0,d="";if(Math.abs(h)<1){var v=e.DEFAULTS.ShowEventBoxes?145:130,u=e.DEFAULTS.ShowEventBoxes?25:10;l=h<0?a.y-v:a.y+u,d=h<0?"top":"bottom",(l+120>e.containerHeight||l<0)&&(l=h<0?a.y+u:a.y-v,d=h<0?"bottom":"top"),s=a.x-60,e.lastAnchorAlignedLeft=!1}else{var A=e.DEFAULTS.ShowEventBoxes?30:15;l=a.y-70,s=a.x+A,e.lastAnchorAlignedLeft=!0,d="right"}if(n.eventBoxPosition=d,n.eventBox=e.container.append("div"),n.eventBox.node().classList.add("flow-box-event-container"),n.eventBox.node().style.top=l+"px",n.eventBox.node().style.left=s+"px",n.upperBox=n.eventBox.append("div"),n.upperBox.node().innerHTML=t.upper,n.lowerBox=n.eventBox.append("div"),n.lowerBox.node().classList.add("flow-box-event-text"),n.lowerBox.node().innerHTML=t.lower,e.DEFAULTS.ShowEventBoxes){var p=n.eventBox.append("div");n.eventBox.attr("data-color",t.nodeColor),n.eventBox.node().style.background=LightenDarkenColor(t.nodeColor,120),n.eventBox.node().style.borderColor=t.nodeColor,p.node().classList.add(d+"-side-arrow"),"top"===d?p.node().style.borderTopColor=t.nodeColor:"bottom"===d?p.node().style.borderBottomColor=t.nodeColor:"right"===d&&(p.node().style.borderRightColor=t.nodeColor),n.lowerBox.node().style.background=t.nodeColor,n.lowerBox.node().style.color="#FFF"}e.anchors.push(n)}},t.prototype.reset=function(){console.log("reset");var t=this;t.lastAnchorAtLength=null,t.anchors.forEach(function(t){t.innerNode.remove(),t.outerNode.remove(),t.lowerBox.remove(),t.upperBox.remove(),t.eventBox.remove()}),t.anchors=[],t.initialize([])},t.prototype.getNodes=function(){return this.anchors.map(function(t){return t.data})},t}();