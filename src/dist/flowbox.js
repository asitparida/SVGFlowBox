function LightenDarkenColor(t,e){var n=!1;"#"==t[0]&&(t=t.slice(1),n=!0);var o=parseInt(t,16),r=(o>>16)+e;r>255?r=255:r<0&&(r=0);var a=(o>>8&255)+e;a>255?a=255:a<0&&(a=0);var i=(255&o)+e;return i>255?i=255:i<0&&(i=0),(n?"#":"")+(i|a<<8|r<<16).toString(16)}function hexToRgb(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function GUID(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+"-"+t()}var FLOW_DEFAULTS={DefaultAnchorNodeSpacing:50,DefaultCurveColor:"#6dc1ff",ShowPlanarMid:!1,ShowCurveAnchors:!1,DefaultNodeColor:"#007c6",DefaultContainerHeightFraction:1,ShowEventBoxes:!0,DefaultCurveIsSolid:!1,DefaultCuveStrokeDasharray:"2, 2"},FlowBoxNode=function(){return function(t,e,n){void 0===t&&(t=""),void 0===e&&(e=""),void 0===n&&(n=FLOW_DEFAULTS.DefaultNodeColor),this.lower=t,this.upper=e,this.nodeColor=n}}(),FlowAnchor=function(){return function(){}}(),FlowBox=function(){function t(t,e,n){this.anchors=[],this.lastAnchorAtLength=null,this.curveAnchors=[],this.lastCurveAnchor=null;var o=this;o.DEFAULTS=t,o.container=d3.select(document.getElementById(e)),o.container.node().classList.add("flow-box-container");var r=o.container.node().getBoundingClientRect().width;o.containerWidth=r;var a=window.innerHeight;1!==o.DEFAULTS.DefaultContainerHeightFraction?(o.containerHeight=a*o.DEFAULTS.DefaultContainerHeightFraction,o.container.node().style.height=o.containerHeight+"px"):o.containerHeight=o.container.node().getBoundingClientRect().height,o.planarY=.5*o.containerHeight,setTimeout(function(){o.svg=o.container.append("svg").attr("width",r).attr("height",o.containerHeight),setTimeout(function(){o.initialize(n)})})}return t.prototype.initialize=function(t){var e=this;e.svg.empty(),e.extendPlanarCurve(),e.DEFAULTS.ShowPlanarMid&&e.drawPlanarMidLine(),e.initNodes(t)},t.prototype.initNodes=function(t){var e=this;t.forEach(function(t){e.addAnchor(t,!1)})},t.prototype.extendPlanarCurve=function(){var t=this;null==t.lastCurveAnchor&&(t.curveAnchors.push([0,t.planarY+100]),t.lastCurveAnchor=[0,t.planarY+100]);var e=t.containerHeight/5;t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY-1*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+300,t.planarY-2*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+50,t.planarY+1.5*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY+1.7*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY-1.5*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY-1.7*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+50,t.planarY+e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+150,t.planarY+1.5*e),t.insertIntoCurveAnchor(t.lastCurveAnchor[0]+200,t.planarY),t.drawPlanarCurve()},t.prototype.insertIntoCurveAnchor=function(t,e){var n=this;n.curveAnchors.push([t,e]),n.lastCurveAnchor=[t,e]},t.prototype.drawPlanarCurve=function(){var t=this;t.curveAnchors.forEach(function(e){t.containerWidth=t.containerWidth>e[0]?t.containerWidth:e[0],t.svg.attr("width",t.containerWidth),t.DEFAULTS.ShowCurveAnchors&&t.svg.append("circle").attr("cx",e[0]).attr("cy",e[1]).attr("r",5).attr("fill","#000")}),t.curve&&t.curve.remove(),t.curve=t.svg.append("path").data([t.curveAnchors]).attr("d",d3.line().curve(d3.curveBasis)).attr("stroke-width",2).attr("stroke",t.DEFAULTS.DefaultCurveColor).attr("stroke-dasharray",!0===t.DEFAULTS.DefaultCurveIsSolid?"0, 0":t.DEFAULTS.DefaultCuveStrokeDasharray).attr("fill","none")},t.prototype.drawPlanarMidLine=function(){var t=this;t.planarMidPath=t.svg.append("line").attr("x1",0).attr("y1",t.planarY).attr("x2",t.containerWidth).attr("y2",t.planarY).attr("stroke-width",1).attr("stroke","#e74c3c")},t.prototype.addAnchor=function(t,e){void 0===e&&(e=!0);var n=this,o=new FlowAnchor;o.data=t;var r=!1,a=n.curve.node().getTotalLength();n.lastAnchorAtLength?(n.lastAnchor=n.curve.node().getPointAtLength(n.lastAnchorAtLength),n.lastAnchorAtLength=n.lastAnchorAtLength+n.DEFAULTS.DefaultAnchorNodeSpacing):(n.lastAnchorAtLength=0,n.lastAnchor={x:-50,y:0},n.lastAnchorAtLength=n.lastAnchorAtLength+100);var i;if(i=n.curve.node().getPointAtLength(n.lastAnchorAtLength),Math.abs(i.y-n.lastAnchor.y)<100)for(var c=n.lastAnchorAlignedLeft?220:130;i.x-n.lastAnchor.x<=c;)n.lastAnchorAtLength=n.lastAnchorAtLength+25,!r&&n.lastAnchorAtLength>a&&(n.extendPlanarCurve(),r=!0),i=n.curve.node().getPointAtLength(n.lastAnchorAtLength);if(i){o.anchor=i,o.innerNode=n.svg.append("circle").attr("cx",i.x).attr("cy",i.y).attr("r",5).attr("fill",t.nodeColor),o.outerNode=n.svg.append("circle").attr("cx",i.x).attr("cy",i.y).attr("r",10).attr("stroke-width",3).attr("stroke",t.nodeColor).attr("fill","none");var l,h=n.curve.node().getPointAtLength(n.lastAnchorAtLength+1),s=(h.y-i.y)/(h.x-i.x),d=void 0,u="";if(Math.abs(s)<1){var v=n.DEFAULTS.ShowEventBoxes?145:130,A=n.DEFAULTS.ShowEventBoxes?25:10;l=s<0?i.y-v:i.y+A,u=s<0?"top":"bottom",(l+120>n.containerHeight||l<0)&&(l=s<0?i.y+A:i.y-v,u=s<0?"bottom":"top"),d=i.x-60,n.lastAnchorAlignedLeft=!1}else{var p=n.DEFAULTS.ShowEventBoxes?30:15;l=i.y-70,d=i.x+p,n.lastAnchorAlignedLeft=!0,u="right"}if(o.eventBoxPosition=u,o.eventBox=n.container.append("div"),o.eventBox.node().classList.add("flow-box-event-container"),o.eventBox.attr("id",GUID()+"_EVB"),o.eventBox.node().style.top=l+"px",o.eventBox.node().style.left=d+"px",o.upperBox=o.eventBox.append("div"),o.upperBox.node().innerHTML=t.upper,o.lowerBox=o.eventBox.append("div"),o.lowerBox.node().classList.add("flow-box-event-text"),o.lowerBox.node().innerHTML=t.lower,n.DEFAULTS.ShowEventBoxes){var g=o.eventBox.append("div");o.eventBox.attr("data-color",t.nodeColor),o.eventBox.node().style.background=LightenDarkenColor(t.nodeColor,120),o.eventBox.node().style.borderColor=t.nodeColor,g.node().classList.add(u+"-side-arrow"),"top"===u?g.node().style.borderTopColor=t.nodeColor:"bottom"===u?g.node().style.borderBottomColor=t.nodeColor:"right"===u&&(g.node().style.borderRightColor=t.nodeColor),o.lowerBox.node().style.background=t.nodeColor,o.lowerBox.node().style.color="#FFF"}if(n.anchors.push(o),e){var f=d-150;$(n.container.node()).animate({scrollLeft:f+"px"},300)}}},t.prototype.reset=function(){console.log("reset");var t=this;t.lastAnchorAtLength=null,t.anchors.forEach(function(t){t.innerNode.remove(),t.outerNode.remove(),t.lowerBox.remove(),t.upperBox.remove(),t.eventBox.remove()}),t.anchors=[],t.initialize([])},t.prototype.getNodes=function(){return this.anchors.map(function(t){return t.data})},t}();